<template>
  <div class="tools-tab" style="padding: 25px !important; background: #1a1a1a !important">
    <div
      class="section-header"
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 20px 25px !important;
        border-bottom: 1px solid #3a3a3a;
        margin-bottom: 5px;
      "
    >
      <h3
        style="
          margin: 0;
          color: #fff;
          font-size: 15px !important;
          font-weight: bold;
          display: flex;
          align-items: center;
          gap: 8px;
        "
      >
        ğŸ› ï¸ å†™å¡å·¥å…·æ¨¡æ¿
      </h3>
      <div class="header-actions" style="display: flex; align-items: center; gap: 10px">
        <span
          class="count-badge"
          style="background: #4a9eff; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px"
          >2 ä¸ªå·¥å…·</span
        >
      </div>
    </div>

    <div class="tools-list" style="display: flex; flex-direction: column; gap: 15px; margin-top: 20px">
      <!-- ä¸“ä¸šè§’è‰²å¡æ¨¡æ¿å·¥å…· -->
      <div
        class="tool-item"
        style="
          background: #2a2a2a;
          border: 1px solid #444;
          border-radius: 8px;
          padding: 15px;
          transition: all 0.3s ease;
        "
      >
        <div
          class="tool-header"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 10px 0;
            border-bottom: 1px solid #3a3a3a;
            margin-bottom: 15px;
          "
          @click="toggleToolExpanded('character-template')"
        >
          <h4 style="margin: 0; color: #fff; font-size: 16px; font-weight: 600">ğŸ“ è§’è‰²å¡æ¨¡æ¿</h4>
          <i
            :class="
              isToolExpanded('character-template')
                ? 'fa-solid fa-chevron-up expand-icon'
                : 'fa-solid fa-chevron-down expand-icon'
            "
            style="color: #888; font-size: 14px; transition: transform 0.2s"
          ></i>
        </div>
        <div class="tool-description" style="color: #ccc; font-size: 14px; line-height: 1.5; margin-bottom: 15px">
          æè¿°è§’è‰²ç‰¹å¾ï¼ŒAIè‡ªåŠ¨ç”Ÿæˆå®Œæ•´çš„è§’è‰²å¡æ¨¡æ¿ã€‚æ­¤åŠŸèƒ½ä»…ä¾›å‚è€ƒï¼Œè¾…åŠ©å†™å¡ï¼Œå¹¶ä¸æ˜¯å…¨è‡ªåŠ¨å†™å¡ï¼Œæ ¼å¼æ˜¯yaml
        </div>
        <div
          v-if="isToolExpanded('character-template')"
          class="tool-content"
          style="padding: 20px; background: #1a1a1a; border-radius: 6px; border: 1px solid #3a3a3a"
        >
          <div class="character-template-tool" style="display: flex; flex-direction: column; gap: 20px">
            <div class="tool-section" style="display: flex; flex-direction: column; gap: 10px">
              <h5 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600">ğŸ­ è§’è‰²æè¿°</h5>
              <textarea
                v-model="characterDescription"
                placeholder="è¯·æè¿°æ‚¨æƒ³è¦åˆ›å»ºçš„è§’è‰²ï¼Œä¾‹å¦‚ï¼š&#10;&#10;ä¸€ä¸ª18å²çš„å¥³å­¦ç”Ÿï¼Œæ€§æ ¼æ¸©æŸ”å†…å‘ä½†å¾ˆç»†å¿ƒï¼Œæ˜¯ç”¨æˆ·é’æ¢…ç«¹é©¬çš„æœ‹å‹ã€‚å¥¹å–œæ¬¢è¯»ä¹¦å’Œç”»ç”»ï¼Œå¹³æ—¶è¯´è¯è½»å£°ç»†è¯­ï¼Œä½†åœ¨ç†Ÿæ‚‰çš„äººé¢å‰ä¼šå˜å¾—æ´»æ³¼ã€‚å¥¹æ€»æ˜¯æˆ´ç€å°æ—¶å€™ç”¨æˆ·é€çš„æ‰‹é“¾ï¼Œå¯¹ç”¨æˆ·æœ‰ç‰¹æ®Šçš„æ„Ÿæƒ…ä½†ä¸æ•¢è¡¨è¾¾ã€‚&#10;&#10;è¯·å°½é‡è¯¦ç»†æè¿°è§’è‰²çš„å¤–è²Œã€æ€§æ ¼ã€èƒŒæ™¯ã€çˆ±å¥½ã€ä¸ç”¨æˆ·çš„å…³ç³»ç­‰..."
                class="character-description-textarea"
                style="
                  width: 100%;
                  min-height: 200px;
                  padding: 15px;
                  background: #1a1a1a;
                  border: 1px solid #444;
                  border-radius: 6px;
                  color: #e0e0e0;
                  font-size: 14px;
                  line-height: 1.5;
                  resize: vertical;
                  font-family: inherit;
                "
              ></textarea>
            </div>

            <div class="tool-actions" style="display: flex; gap: 12px; justify-content: center">
              <button
                :disabled="!characterDescription.trim() || isGeneratingCharacter"
                class="generate-button"
                style="
                  padding: 12px 24px;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  border: none;
                  border-radius: 8px;
                  color: white;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: 600;
                  transition: all 0.3s ease;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                  position: relative;
                  overflow: hidden;
                "
                @click="handleGenerateCharacterCard"
              >
                <div
                  style="
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                    transition: left 0.5s;
                  "
                  class="shimmer-effect"
                ></div>
                <i v-if="!isGeneratingCharacter" class="fa-solid fa-magic" style="font-size: 16px"></i>
                <i v-else class="fa-solid fa-spinner fa-spin" style="font-size: 16px"></i>
                {{ isGeneratingCharacter ? 'AIç”Ÿæˆä¸­...' : 'AIç”Ÿæˆè§’è‰²å¡' }}
              </button>
              <button
                :disabled="!characterDescription.trim()"
                class="clear-button"
                style="
                  padding: 12px 24px;
                  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
                  border: none;
                  border-radius: 8px;
                  color: white;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: 600;
                  transition: all 0.3s ease;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                  position: relative;
                  overflow: hidden;
                "
                @click="clearCharacterForm"
              >
                <div
                  style="
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                    transition: left 0.5s;
                  "
                  class="shimmer-effect"
                ></div>
                <i class="fa-solid fa-trash" style="font-size: 16px"></i> æ¸…ç©ºå†…å®¹
              </button>
            </div>

            <div v-if="characterCardOutput" class="tool-section">
              <h5>âœ¨ ç”Ÿæˆçš„è§’è‰²å¡</h5>
              <div class="character-card-container">
                <textarea
                  v-model="characterCardOutput"
                  class="character-card-textarea"
                  readonly
                  placeholder="ç”Ÿæˆçš„è§’è‰²å¡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."
                ></textarea>
                <div
                  class="output-actions"
                  style="
                    display: flex;
                    gap: 12px;
                    justify-content: center;
                    padding: 15px 20px;
                    background: #2a2a2a;
                    border-top: 1px solid #3a3a3a;
                    margin: 0;
                  "
                >
                  <button
                    class="copy-button"
                    style="
                      padding: 10px 20px;
                      background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                      border: none;
                      border-radius: 6px;
                      color: white;
                      cursor: pointer;
                      font-size: 13px;
                      font-weight: 600;
                      transition: all 0.3s ease;
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      box-shadow: 0 3px 12px rgba(40, 167, 69, 0.3);
                      position: relative;
                      overflow: hidden;
                    "
                    @click="copyCharacterCard"
                  >
                    <div
                      style="
                        position: absolute;
                        top: 0;
                        left: -100%;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                        transition: left 0.5s;
                      "
                      class="shimmer-effect"
                    ></div>
                    <i class="fa-solid fa-copy" style="font-size: 14px"></i> å¤åˆ¶è§’è‰²å¡
                  </button>
                </div>
              </div>
            </div>

            <!-- è§’è‰²å¡ç¼–è¾‘åŒºåŸŸ -->
            <div v-if="characterCardOutput" class="tool-section">
              <h5>ğŸ”§ è§’è‰²å¡ç¼–è¾‘</h5>
              <div class="edit-section">
                <label for="editInstructions" class="edit-label">ä¿®æ”¹è¯´æ˜ï¼š</label>
                <textarea
                  id="editInstructions"
                  v-model="editInstructions"
                  class="edit-textarea"
                  placeholder="è¯·æè¿°éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ï¼Œä¾‹å¦‚ï¼š&#10;- æŠŠå¹´é¾„æ”¹ä¸º25å²&#10;- ä¿®æ”¹æ€§æ ¼ä¸ºæ›´æ´»æ³¼å¼€æœ—&#10;- æ·»åŠ ä¸€ä¸ªç‰¹æ®Šçˆ±å¥½&#10;- è°ƒæ•´å¯¹è¯é£æ ¼ä¸ºæ›´æ­£å¼"
                  rows="4"
                ></textarea>
                <div class="edit-actions">
                  <button
                    class="edit-button"
                    :disabled="!editInstructions.trim() || isEditingCharacter"
                    @click="handleEditCharacterCard"
                  >
                    <i v-if="!isEditingCharacter" class="fa-solid fa-magic"></i>
                    <i v-else class="fa-solid fa-spinner fa-spin"></i>
                    {{ isEditingCharacter ? 'AIä¿®æ”¹ä¸­...' : 'AIä¿®æ”¹è§’è‰²å¡' }}
                  </button>
                  <button class="reset-button" @click="resetEditForm"><i class="fa-solid fa-undo"></i> é‡ç½®ç¼–è¾‘</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- åå…«è‚¡ç¼–è¾‘å·¥å…· -->
      <div
        class="tool-item"
        style="
          background: #2a2a2a;
          border: 1px solid #444;
          border-radius: 8px;
          padding: 15px;
          transition: all 0.3s ease;
        "
      >
        <div
          class="tool-header"
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
            padding: 10px 0;
            border-bottom: 1px solid #3a3a3a;
            margin-bottom: 15px;
          "
          @click="toggleToolExpanded('anti-cliche-edit')"
        >
          <h4 style="margin: 0; color: #fff; font-size: 16px; font-weight: 600">âœ‚ï¸ æœ€è®¨åŒå…«è‚¡</h4>
          <i
            :class="
              isToolExpanded('anti-cliche-edit')
                ? 'fa-solid fa-chevron-up expand-icon'
                : 'fa-solid fa-chevron-down expand-icon'
            "
            style="color: #888; font-size: 14px; transition: transform 0.2s"
          ></i>
        </div>
        <div class="tool-description" style="color: #ccc; font-size: 14px; line-height: 1.5; margin-bottom: 15px">
          AIè‡ªåŠ¨æ£€æµ‹å¹¶æ¸…ç†æ–‡æœ¬ä¸­çš„å…«è‚¡è¡¨è¿°ï¼Œå»é™¤æ¨¡ç³Šè¯ã€æ¯”å–»è¯ã€å¾®è¡¨æƒ…ç­‰åˆ»æ¿åŒ–è¡¨è¾¾ã€‚æ­¤åŠŸèƒ½ä»…ä¾›å‚è€ƒï¼Œè¾…åŠ©å†™å¡å“¦å–µ
        </div>
        <div
          v-if="isToolExpanded('anti-cliche-edit')"
          class="tool-content"
          style="padding: 20px; background: #1a1a1a; border-radius: 6px; border: 1px solid #3a3a3a"
        >
          <div class="anti-cliche-tool" style="display: flex; flex-direction: column; gap: 20px">
            <div class="tool-section" style="display: flex; flex-direction: column; gap: 10px">
              <h5 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600">ğŸ“ è¾“å…¥æ–‡æœ¬</h5>
              <textarea
                v-model="antiClicheInput"
                placeholder="è¯·ç²˜è´´éœ€è¦æ¸…ç†çš„æ–‡æœ¬å†…å®¹..."
                class="anti-cliche-textarea"
                style="
                  width: 100%;
                  min-height: 120px;
                  padding: 12px;
                  background: #2a2a2a;
                  border: 1px solid #3a3a3a;
                  border-radius: 6px;
                  color: #e0e0e0;
                  font-size: 14px;
                  resize: vertical;
                  font-family: inherit;
                "
              ></textarea>
            </div>

            <div class="tool-actions" style="display: flex; gap: 12px; justify-content: center">
              <button
                :disabled="!antiClicheInput.trim() || isProcessingAntiCliche"
                class="process-button"
                style="
                  padding: 12px 24px;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  border: none;
                  border-radius: 8px;
                  color: white;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: 600;
                  transition: all 0.3s ease;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
                  position: relative;
                  overflow: hidden;
                "
                @click="handleAntiClicheProcess"
              >
                <div
                  style="
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                    transition: left 0.5s;
                  "
                  class="shimmer-effect"
                ></div>
                <i v-if="!isProcessingAntiCliche" class="fa-solid fa-magic" style="font-size: 16px"></i>
                <i v-else class="fa-solid fa-spinner fa-spin" style="font-size: 16px"></i>
                {{ isProcessingAntiCliche ? 'AIå¤„ç†ä¸­...' : 'AIè‡ªåŠ¨æ¸…ç†' }}
              </button>
              <button
                :disabled="!antiClicheInput.trim()"
                class="clear-button"
                style="
                  padding: 12px 24px;
                  background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
                  border: none;
                  border-radius: 8px;
                  color: white;
                  cursor: pointer;
                  font-size: 14px;
                  font-weight: 600;
                  transition: all 0.3s ease;
                  display: flex;
                  align-items: center;
                  gap: 8px;
                  box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
                  position: relative;
                  overflow: hidden;
                "
                @click="antiClicheInput = ''"
              >
                <div
                  style="
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                    transition: left 0.5s;
                  "
                  class="shimmer-effect"
                ></div>
                <i class="fa-solid fa-trash" style="font-size: 16px"></i> æ¸…ç©º
              </button>
            </div>

            <div v-if="antiClicheOutput" class="tool-section" style="display: flex; flex-direction: column; gap: 10px">
              <h5 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600">âœ¨ æ¸…ç†ç»“æœ</h5>
              <div
                class="anti-cliche-output"
                style="
                  background: #2a2a2a;
                  border: 1px solid #3a3a3a;
                  border-radius: 6px;
                  padding: 15px;
                  color: #e0e0e0;
                  font-size: 14px;
                  line-height: 1.6;
                  white-space: pre-wrap;
                  min-height: 100px;
                "
              >
                {{ antiClicheOutput }}
              </div>
              <div class="output-actions" style="display: flex; gap: 12px; justify-content: center">
                <button
                  class="copy-button"
                  style="
                    padding: 10px 20px;
                    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
                    border: none;
                    border-radius: 6px;
                    color: white;
                    cursor: pointer;
                    font-size: 13px;
                    font-weight: 600;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    box-shadow: 0 3px 12px rgba(40, 167, 69, 0.3);
                    position: relative;
                    overflow: hidden;
                  "
                  @click="copyAntiClicheResult"
                >
                  <div
                    style="
                      position: absolute;
                      top: 0;
                      left: -100%;
                      width: 100%;
                      height: 100%;
                      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
                      transition: left 0.5s;
                    "
                    class="shimmer-effect"
                  ></div>
                  <i class="fa-solid fa-copy" style="font-size: 14px"></i> å¤åˆ¶ç»“æœ
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { storeToRefs } from 'pinia';
import { ref } from 'vue';
import { useSettingsStore } from '../settings';

const settingsStore = useSettingsStore();
const { settings } = storeToRefs(settingsStore);

// å“åº”å¼æ•°æ®
const toolExpandedState = ref(new Map<string, boolean>());
const antiClicheInput = ref('');
const antiClicheOutput = ref('');
const isProcessingAntiCliche = ref(false);
const characterDescription = ref('');
const characterCardOutput = ref('');
const isGeneratingCharacter = ref(false);
const editInstructions = ref('');
const isEditingCharacter = ref(false);

// åˆ‡æ¢å·¥å…·å±•å¼€çŠ¶æ€
const toggleToolExpanded = (toolName: string) => {
  console.log('toggleToolExpanded è¢«è°ƒç”¨ï¼Œå·¥å…·åç§°:', toolName);
  const current = toolExpandedState.value.get(toolName) || false;
  console.log('å½“å‰å±•å¼€çŠ¶æ€:', current);
  toolExpandedState.value.set(toolName, !current);
  console.log('æ–°çš„å±•å¼€çŠ¶æ€:', !current);
};

// æ£€æŸ¥å·¥å…·æ˜¯å¦å±•å¼€
const isToolExpanded = (toolName: string) => {
  return toolExpandedState.value.get(toolName) || false;
};

// ç»Ÿä¸€çš„å¤åˆ¶å‡½æ•° - é’ˆå¯¹iframeç¯å¢ƒä¼˜åŒ–
const copyToClipboard = async (text: string, successMessage: string = 'å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿') => {
  console.log('å¼€å§‹å¤åˆ¶ï¼Œæ–‡æœ¬é•¿åº¦:', text.length);

  try {
    // åœ¨iframeç¯å¢ƒä¸­ï¼Œä¼˜å…ˆå°è¯•åœ¨çˆ¶çª—å£ä¸­å¤åˆ¶
    if (window.parent && window.parent !== window) {
      console.log('æ£€æµ‹åˆ°iframeç¯å¢ƒï¼Œå°è¯•åœ¨çˆ¶çª—å£å¤åˆ¶');
      const parentSuccess = await tryParentWindowCopy(text);
      if (parentSuccess) {
        console.log('çˆ¶çª—å£å¤åˆ¶æˆåŠŸ');
        window.toastr.success(successMessage);
        return;
      }
    }

    // æ–¹æ³•1: å°è¯•ä½¿ç”¨ç°ä»£çš„ Clipboard APIï¼ˆä»…åœ¨å®‰å…¨ä¸Šä¸‹æ–‡ä¸­ï¼‰
    if (navigator.clipboard && window.isSecureContext) {
      console.log('ä½¿ç”¨ç°ä»£ Clipboard API');
      try {
        await navigator.clipboard.writeText(text);
        console.log('Clipboard API å¤åˆ¶æˆåŠŸ');
        window.toastr.success(successMessage);
        return;
      } catch (clipboardErr) {
        console.warn('Clipboard API å¤±è´¥:', clipboardErr);
        // ç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•
      }
    }

    // æ–¹æ³•2: ä½¿ç”¨ä¼ ç»Ÿçš„ execCommand æ–¹æ³•
    console.log('ä½¿ç”¨ execCommand æ–¹æ³•');
    const success = await execCommandCopy(text);
    if (success) {
      console.log('execCommand å¤åˆ¶æˆåŠŸ');
      window.toastr.success(successMessage);
      return;
    }

    // æ–¹æ³•3: å¦‚æœéƒ½å¤±è´¥äº†ï¼Œæ˜¾ç¤ºæ–‡æœ¬æ¡†è®©ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶
    console.log('æ‰€æœ‰è‡ªåŠ¨å¤åˆ¶æ–¹æ³•éƒ½å¤±è´¥ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨å¤åˆ¶ç•Œé¢');
    showManualCopyDialog(text);
  } catch (err) {
    console.error('å¤åˆ¶å¼‚å¸¸:', err);
    // å‡ºé”™æ—¶ä¹Ÿæ˜¾ç¤ºæ‰‹åŠ¨å¤åˆ¶ç•Œé¢
    showManualCopyDialog(text);
  }
};

// åœ¨çˆ¶çª—å£ä¸­å°è¯•å¤åˆ¶
const tryParentWindowCopy = async (text: string): Promise<boolean> => {
  return new Promise(resolve => {
    try {
      const parentDoc = window.parent.document;
      const parentBody = window.parent.document.body;

      // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ textarea å…ƒç´ åœ¨çˆ¶çª—å£ä¸­
      const textarea = parentDoc.createElement('textarea');
      textarea.value = text;
      textarea.style.cssText = `
        position: fixed;
        left: -9999px;
        top: -9999px;
        opacity: 0;
        pointer-events: none;
        z-index: -1000;
      `;
      textarea.setAttribute('readonly', '');

      parentBody.appendChild(textarea);

      // é€‰ä¸­æ–‡æœ¬
      textarea.focus();
      textarea.select();
      textarea.setSelectionRange(0, text.length);

      // å°è¯•å¤åˆ¶
      const success = parentDoc.execCommand('copy');

      // æ¸…ç†
      parentBody.removeChild(textarea);

      resolve(success);
    } catch (err) {
      console.error('çˆ¶çª—å£å¤åˆ¶å¤±è´¥:', err);
      resolve(false);
    }
  });
};

// execCommand å¤åˆ¶æ–¹æ³•
const execCommandCopy = async (text: string): Promise<boolean> => {
  return new Promise(resolve => {
    try {
      // åˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„ textarea å…ƒç´ 
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.left = '-9999px';
      textarea.style.top = '-9999px';
      textarea.style.opacity = '0';
      textarea.style.pointerEvents = 'none';
      textarea.setAttribute('readonly', '');

      document.body.appendChild(textarea);

      // é€‰ä¸­æ–‡æœ¬
      textarea.select();
      textarea.setSelectionRange(0, text.length);

      // å°è¯•å¤åˆ¶
      const success = document.execCommand('copy');

      // æ¸…ç†
      document.body.removeChild(textarea);

      resolve(success);
    } catch (err) {
      console.error('execCommand å¤åˆ¶å¤±è´¥:', err);
      resolve(false);
    }
  });
};

// æ‰‹åŠ¨å¤åˆ¶å¯¹è¯æ¡† - æ›´å¯é çš„å®ç°
const showManualCopyDialog = (text: string) => {
  console.log('æ˜¾ç¤ºæ‰‹åŠ¨å¤åˆ¶å¯¹è¯æ¡†ï¼Œæ–‡æœ¬é•¿åº¦:', text.length);

  try {
    // ä½¿ç”¨çˆ¶çª—å£çš„documentæ¥åˆ›å»ºå…ƒç´ 
    const parentDoc = window.parent.document;
    const parentBody = window.parent.document.body;

    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§å¯¹è¯æ¡†
    const existingOverlay = parentDoc.getElementById('manual-copy-overlay');
    if (existingOverlay) {
      parentBody.removeChild(existingOverlay);
    }

    // åˆ›å»ºé®ç½©å±‚
    const overlay = parentDoc.createElement('div');
    overlay.id = 'manual-copy-overlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 999999;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    `;

    // åˆ›å»ºä¸»å®¹å™¨
    const container = parentDoc.createElement('div');
    container.style.cssText = `
      background: #2a2a2a;
      border: 2px solid #4a9eff;
      border-radius: 12px;
      padding: 25px;
      max-width: 900px;
      width: 95%;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    `;

    // åˆ›å»ºæ ‡é¢˜
    const header = parentDoc.createElement('div');
    header.innerHTML = `
      <h3 style="margin: 0 0 15px 0; color: #4a9eff; text-align: center; font-size: 18px; font-weight: 600;">
        ğŸ“‹ æ‰‹åŠ¨å¤åˆ¶å†…å®¹
      </h3>
      <div style="background: #1a1a1a; border: 1px solid #444; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
        <p style="margin: 0 0 8px 0; color: #e0e0e0; font-size: 14px;">
          <strong>æ“ä½œæ­¥éª¤ï¼š</strong>
        </p>
        <ol style="margin: 0; padding-left: 20px; color: #ccc; font-size: 13px; line-height: 1.6;">
          <li>ç‚¹å‡»ä¸‹æ–¹æ–‡æœ¬æ¡†</li>
          <li>æŒ‰ <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Ctrl+A</kbd> å…¨é€‰æ–‡æœ¬</li>
          <li>æŒ‰ <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Ctrl+C</kbd> å¤åˆ¶åˆ°å‰ªè´´æ¿</li>
          <li>ç‚¹å‡»"å…³é—­"æŒ‰é’®æˆ–æŒ‰ <kbd style="background: #444; padding: 2px 6px; border-radius: 3px; color: #fff;">Esc</kbd> å…³é—­å¯¹è¯æ¡†</li>
        </ol>
      </div>
    `;

    // åˆ›å»ºæ–‡æœ¬æ¡†
    const textarea = parentDoc.createElement('textarea');
    textarea.value = text;
    textarea.style.cssText = `
      width: 100%;
      height: 400px;
      background: #1a1a1a;
      border: 2px solid #444;
      border-radius: 6px;
      padding: 15px;
      color: #e0e0e0;
      font-family: 'Courier New', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.5;
      resize: vertical;
      white-space: pre-wrap;
      word-wrap: break-word;
      outline: none;
      margin-bottom: 20px;
      box-sizing: border-box;
    `;

    // åˆ›å»ºæŒ‰é’®å®¹å™¨
    const buttonContainer = parentDoc.createElement('div');
    buttonContainer.style.cssText = `
      display: flex;
      gap: 12px;
      justify-content: center;
      align-items: center;
    `;

    // åˆ›å»ºå…³é—­æŒ‰é’®
    const closeButton = parentDoc.createElement('button');
    closeButton.textContent = 'å…³é—­';
    closeButton.style.cssText = `
      background: #4a9eff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    `;
    closeButton.onmouseover = () => {
      closeButton.style.background = '#5ba8ff';
    };
    closeButton.onmouseout = () => {
      closeButton.style.background = '#4a9eff';
    };

    // åˆ›å»ºå¤åˆ¶æŒ‰é’®ï¼ˆå¤‡ç”¨ï¼‰
    const copyButton = parentDoc.createElement('button');
    copyButton.textContent = 'å°è¯•è‡ªåŠ¨å¤åˆ¶';
    copyButton.style.cssText = `
      background: #28a745;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: background 0.2s;
    `;
    copyButton.onmouseover = () => {
      copyButton.style.background = '#218838';
    };
    copyButton.onmouseout = () => {
      copyButton.style.background = '#28a745';
    };

    // ç»„è£…å…ƒç´ 
    buttonContainer.appendChild(copyButton);
    buttonContainer.appendChild(closeButton);

    container.appendChild(header);
    container.appendChild(textarea);
    container.appendChild(buttonContainer);
    overlay.appendChild(container);

    // æ·»åŠ åˆ°é¡µé¢
    parentBody.appendChild(overlay);

    // äº‹ä»¶å¤„ç†
    closeButton.onclick = () => {
      console.log('å…³é—­æŒ‰é’®è¢«ç‚¹å‡»');
      parentBody.removeChild(overlay);
    };

    copyButton.onclick = async () => {
      console.log('å°è¯•è‡ªåŠ¨å¤åˆ¶æŒ‰é’®è¢«ç‚¹å‡»');
      try {
        // é€‰ä¸­æ–‡æœ¬
        textarea.focus();
        textarea.select();

        // å°è¯•å¤åˆ¶
        const success = document.execCommand('copy');
        if (success) {
          window.toastr.success('è‡ªåŠ¨å¤åˆ¶æˆåŠŸï¼');
          parentBody.removeChild(overlay);
        } else {
          window.toastr.warning('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
        }
      } catch (err) {
        console.error('è‡ªåŠ¨å¤åˆ¶å¤±è´¥:', err);
        window.toastr.warning('è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
      }
    };

    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    overlay.onclick = e => {
      if (e.target === overlay) {
        console.log('ç‚¹å‡»èƒŒæ™¯å…³é—­');
        parentBody.removeChild(overlay);
      }
    };

    // é”®ç›˜äº‹ä»¶å¤„ç†
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        console.log('æŒ‰ESCé”®å…³é—­');
        parentBody.removeChild(overlay);
        parentDoc.removeEventListener('keydown', handleKeyDown);
      }
    };
    parentDoc.addEventListener('keydown', handleKeyDown);

    // è‡ªåŠ¨é€‰ä¸­æ–‡æœ¬
    setTimeout(() => {
      console.log('è‡ªåŠ¨é€‰ä¸­æ–‡æœ¬');
      textarea.focus();
      textarea.select();
    }, 200);

    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    window.toastr.info('æ‰‹åŠ¨å¤åˆ¶å¯¹è¯æ¡†å·²æ‰“å¼€ï¼Œè¯·æŒ‰ç…§æç¤ºæ“ä½œ');
  } catch (err) {
    console.error('åˆ›å»ºæ‰‹åŠ¨å¤åˆ¶å¯¹è¯æ¡†å¤±è´¥:', err);
    window.toastr.error('æ— æ³•æ˜¾ç¤ºå¤åˆ¶å¯¹è¯æ¡†ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™');
  }
};

// åå…«è‚¡å·¥å…·å¤„ç†å‡½æ•°
const handleAntiClicheProcess = async () => {
  if (!antiClicheInput.value.trim()) {
    window.toastr.warning('è¯·è¾“å…¥éœ€è¦æ¸…ç†çš„æ–‡æœ¬');
    return;
  }

  if (!settings.value.api_key) {
    window.toastr.error('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®API Key');
    return;
  }

  try {
    isProcessingAntiCliche.value = true;
    window.toastr.info('AIæ­£åœ¨åˆ†ææ–‡æœ¬...', 'åå…«è‚¡æ¸…ç†', { timeOut: 15000 });

    const response = await fetch(settings.value.api_endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${settings.value.api_key}`,
      },
      body: JSON.stringify({
        model: settings.value.model,
        messages: [
          {
            role: 'system',
            content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–‡æœ¬ç¼–è¾‘åŠ©æ‰‹ï¼Œä¸“é—¨è´Ÿè´£æ¸…ç†æ–‡æœ¬ä¸­çš„å…«è‚¡è¡¨è¿°ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ ‡å‡†æ¸…ç†æ–‡æœ¬ï¼š

## æ¸…ç†è§„åˆ™ï¼š
1. **å»é™¤æ¨¡ç³Šè¯å’Œç±»æ¯”è¯**ï¼šä¼¼ä¹ã€å‡ ä¹ã€è¿‘ä¹ã€å¥½åƒã€ä»¿ä½›ã€å¦‚åŒã€å®›å¦‚ã€æ°ä¼¼ã€ä¸€ä¸ã€ä¸€æŠ¹ç­‰
2. **å»é™¤å…«è‚¡æ¯”å–»è¯**ï¼šåƒå°å…”å­ä¸€æ ·ã€åƒå°å…½ä¸€æ ·ã€åƒçŒ«å’ªä¸€æ ·ã€é‡å…½ã€å°å…½ã€å¹¼å…½ç­‰åŠ¨ç‰©åŒ–æ¯”å–»
3. **å»é™¤è¯­æ°”å£°éŸ³æè¿°**ï¼šå¸¦ç€xxxçš„å£å»ã€å£°éŸ³æ¯”å¯’å†°æ›´å†°å†·ã€ç”¨ä¸å®¹ç½®ç–‘çš„è¯­æ°”ç­‰
4. **å»é™¤å¾®è¡¨æƒ…å’Œå¾®åŠ¨ä½œ**ï¼šæµéœ²å‡ºæ¸©æŸ”çš„ç¥è‰²ã€çœ¼é‡Œæ¼¾èµ·æŸ”å’Œçš„æ˜Ÿå…‰ã€å˜´è§’ä¸Šæ‰¬ç­‰
5. **å»é™¤"ä¸æ˜¯â€¦â€¦è€Œæ˜¯â€¦â€¦"å¥å¼**ï¼šç›´æ¥å†™è¡Œä¸ºï¼Œåˆ é™¤å¦å®šè½¬æŠ˜
6. **ä¿®æ”¹å¤–è²Œæè¿°æ–¹å¼**ï¼šé¿å…ç³è‰²æè¿°ã€å¥³æ€§ç½©æ¯ã€ç²¾ç¡®èº«é«˜æ•°å­—ç­‰
7. **é‡å†™è¯­æ–™å’Œæ€§æ ¼æè¿°**ï¼šåªä½¿ç”¨çº¯å¯¹è¯ï¼Œä¸é™„åŠ è¡¨æƒ…åŠ¨ä½œç¥æ€
8. **é˜²æ­¢ç»æœ›/ç¥åŒ–/æŒæ§å€¾å‘**ï¼šå»é™¤è´Ÿé¢æƒ…ç»ªè¯å’Œç¨‹åº¦å‰¯è¯

## è¾“å‡ºè¦æ±‚ï¼š
- ä¿æŒåŸæ–‡çš„æ ¸å¿ƒå†…å®¹å’Œç»“æ„
- åªæ¸…ç†å…«è‚¡è¡¨è¿°ï¼Œä¸æ”¹å˜åŸæ„
- ä¿æŒæ–‡æœ¬çš„è‡ªç„¶æµç•…
- å¦‚æœåŸæ–‡æ²¡æœ‰å…«è‚¡è¡¨è¿°ï¼Œåˆ™è¿”å›åŸæ–‡
- åœ¨æ¸…ç†åçš„æ–‡æœ¬å‰åŠ ä¸Š"ã€æ¸…ç†å®Œæˆã€‘"æ ‡è¯†`,
          },
          {
            role: 'user',
            content: `è¯·æ¸…ç†ä»¥ä¸‹æ–‡æœ¬ä¸­çš„å…«è‚¡è¡¨è¿°ï¼š\n\n${antiClicheInput.value}`,
          },
        ],
        max_tokens: settings.value.max_tokens,
        temperature: settings.value.temperature,
      }),
    });

    if (!response.ok) {
      throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.status}`);
    }

    const result = await response.json();
    const cleanedText = result.choices[0].message.content.trim();

    antiClicheOutput.value = cleanedText;
    window.toastr.success('æ–‡æœ¬æ¸…ç†å®Œæˆï¼');
  } catch (error) {
    console.error('åå…«è‚¡æ¸…ç†å¤±è´¥:', error);
    window.toastr.error('æ¸…ç†å¤±è´¥ï¼š' + (error as Error).message);
  } finally {
    isProcessingAntiCliche.value = false;
  }
};

const copyAntiClicheResult = () => {
  if (!antiClicheOutput.value) {
    window.toastr.warning('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
    return;
  }

  // ä½¿ç”¨ç»Ÿä¸€çš„å¤åˆ¶å‡½æ•°
  copyToClipboard(antiClicheOutput.value, 'æ¸…ç†ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
};

// è§’è‰²å¡ç”Ÿæˆå·¥å…·ç›¸å…³å‡½æ•°
const handleGenerateCharacterCard = async () => {
  if (!characterDescription.value.trim()) {
    window.toastr.warning('è¯·è¾“å…¥è§’è‰²æè¿°');
    return;
  }

  try {
    isGeneratingCharacter.value = true;
    window.toastr.info('AIæ­£åœ¨ç”Ÿæˆè§’è‰²å¡ï¼Œè¯·ç¨å€™...');

    const response = await fetch(settings.value.api_endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${settings.value.api_key}`,
      },
      body: JSON.stringify({
        model: settings.value.model || 'gpt-3.5-turbo',
        max_tokens: 4000,
        temperature: 0.8,
        messages: [
          {
            role: 'system',
            content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§’è‰²å¡ç”Ÿæˆä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„æè¿°ç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„è§’è‰²å¡ï¼ŒåŒ…å«ä»¥ä¸‹å†…å®¹ï¼š
    'textarea[placeholder*="Send"]',
    'textarea[placeholder*="send"]',
    'textarea[placeholder*="è¾“å…¥æ¶ˆæ¯"]',
    'textarea[placeholder*="è¾“å…¥æ–‡æœ¬"]',
    'textarea[placeholder*="Type a message"]',
    'textarea[placeholder*="Enter message"]',

    // åŸºäºå±æ€§çš„é€‰æ‹©å™¨
    'textarea[name="message"]',
    'textarea[name="chat_input"]',
    'textarea[name="user_input"]',

    // åŸºäºdataå±æ€§çš„é€‰æ‹©å™¨
    'textarea[data-testid*="input"]',
    'textarea[data-testid*="message"]',
    'textarea[data-testid*="chat"]',

    // åŸºäºroleçš„é€‰æ‹©å™¨
    'textarea[role="textbox"]',

    // é€šç”¨çš„textareaé€‰æ‹©å™¨ï¼ˆä½œä¸ºæœ€åçš„é€‰æ‹©ï¼‰
    'textarea',
  ];

  for (const selector of selectors) {
    try {
      const element = document.querySelector(selector) as HTMLTextAreaElement;
      if (element && element.tagName.toLowerCase() === 'textarea') {
        // éªŒè¯è¿™ä¸ªtextareaæ˜¯å¦çœŸçš„æ˜¯èŠå¤©è¾“å…¥æ¡†
        const isVisible = element.offsetWidth > 0 && element.offsetHeight > 0;
        const hasContent = element.value !== undefined;
        const isEditable = !element.readOnly && !element.disabled;

        if (isVisible && hasContent && isEditable) {
          console.log(`æ‰¾åˆ°èŠå¤©è¾“å…¥æ¡†ï¼Œä½¿ç”¨é€‰æ‹©å™¨: ${selector}`);
          return element;
        }
      }
    } catch (error) {
      console.warn(`é€‰æ‹©å™¨ ${selector} æŸ¥æ‰¾å¤±è´¥:`, error);
    }
  }

  console.warn('æ‰€æœ‰é€‰æ‹©å™¨éƒ½æ— æ³•æ‰¾åˆ°èŠå¤©è¾“å…¥æ¡†');
  return null;
};

const copyAntiClicheResult = () => {
  if (!antiClicheOutput.value) {
    window.toastr.warning('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
    return;
  }

  // ä½¿ç”¨ç»Ÿä¸€çš„å¤åˆ¶å‡½æ•°
  copyToClipboard(antiClicheOutput.value, 'æ¸…ç†ç»“æœå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
};


// è§’è‰²å¡ç”Ÿæˆå·¥å…·ç›¸å…³å‡½æ•°
const handleGenerateCharacterCard = async () => {
  if (!characterDescription.value.trim()) {
    window.toastr.warning('è¯·è¾“å…¥è§’è‰²æè¿°');
    return;
  }

  try {
    isGeneratingCharacter.value = true;
    window.toastr.info('AIæ­£åœ¨ç”Ÿæˆè§’è‰²å¡ï¼Œè¯·ç¨å€™...');

    const response = await fetch(settings.value.api_endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${settings.value.api_key}`,
      },
      body: JSON.stringify({
        model: settings.value.model || 'gpt-3.5-turbo',
        max_tokens: 4000,
        temperature: 0.8,
        messages: [
          {
            role: 'system',
            content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§’è‰²å¡ç¼–å†™ä¸“å®¶ï¼Œè¯·æŒ‰ç…§YAMLæ ¼å¼ç”Ÿæˆå®Œæ•´çš„è§’è‰²å¡ã€‚

é‡è¦ï¼šè¯·ä½¿ç”¨æ ‡å‡†çš„YAMLæ ¼å¼ï¼ŒåŒ…å«æ­£ç¡®çš„ç¼©è¿›å’Œç»“æ„ã€‚åœ¨è§’è‰²å¡ä¸­ï¼Œç”¨æˆ·ç»Ÿä¸€ç”¨ {{user}} æ¥è¡¨ç¤ºã€‚

æ ¼å¼è¦æ±‚ï¼š
- å§“åéƒ¨åˆ†åªèƒ½å†™ä¸­æ–‡åï¼Œç¦æ­¢æ·»åŠ è‹±æ–‡æˆ–æ‹¬å·ï¼ˆå¦‚"é¡¾è¨€ (Gu Yan)"åº”æ”¹ä¸º"é¡¾è¨€"ï¼‰
- æ˜µç§°éƒ¨åˆ†ä¸è¦åŒ…å«è‹±æ–‡ï¼Œçº¯ä¸­æ–‡å³å¯
- èº«é«˜ç”¨æè¿°æ€§è¯­è¨€ï¼Œä¸è¦ç”¨å…·ä½“æ•°å­—
- æ‰€æœ‰æ‹¬å·å†…å®¹éƒ½å¿…é¡»æ˜¯çº¯ä¸­æ–‡
- ç¦æ­¢ä½¿ç”¨Markdownæ ¼å¼ç¬¦å·ï¼ˆå¦‚#ã€*ã€**ç­‰ï¼‰ï¼Œåªä½¿ç”¨çº¯YAMLæ ¼å¼
- ä¸è¦æ·»åŠ ä»»ä½•æ³¨é‡Šç¬¦å·æˆ–ç‰¹æ®Šæ ‡è®°

è§’è‰²å¡YAMLæ ¼å¼è¦æ±‚ï¼š

åŸºç¡€ä¿¡æ¯éƒ¨åˆ†ï¼š
- å§“åï¼ˆä¸­æ–‡åã€æ˜µç§°ï¼‰
- æ€§åˆ«ã€å¹´é¾„ã€èº«ä»½ã€ç¤¾ä¼šåœ°ä½
- ç›¸è²Œç‰¹å¾ï¼ˆè¯¦ç»†æè¿°å¤–è²Œã€æ°”è´¨ã€ç‰¹ç‚¹ï¼‰

èº«æç‰¹å¾éƒ¨åˆ†ï¼š
- èº«é«˜ä½“å‹ï¼ˆç”¨æè¿°æ€§è¯­è¨€ï¼Œå¦‚"é«˜æŒ‘"ã€"ä¸­ç­‰èº«æ"ã€"å¨‡å°"ç­‰ï¼Œä¸è¦ç”¨å…·ä½“æ•°å­—ï¼‰
- ä½“æ€ç»†èŠ‚ã€ç‰¹æ®Šç»†èŠ‚ã€ä½“é¦™ç­‰

æ€§æ ¼å¡‘é€ éƒ¨åˆ†ï¼š
- æ ¸å¿ƒæ€§æ ¼ç‰¹ç‚¹ï¼ˆåº•è‰²ï¼‰
- è¡Œä¸ºæ¨¡å¼ï¼ˆå¸¸æ€ï¼‰
- çœŸå®æœ¬æ€§
- ç‰¹æ®Šè¡¨ç°ï¼ˆç ´ç»½ã€ä¿æŠ¤æ¬²ç­‰ï¼‰

å¯¹è¯é£æ ¼éƒ¨åˆ†ï¼š
- ç§°å‘¼æ–¹å¼ã€å¸¸ç”¨å¥å¼
- è¯æ±‡åå¥½ã€å£å¤´ç¦…ã€è¯­é€Ÿ

èƒŒæ™¯ç»å†éƒ¨åˆ†ï¼š
- æˆé•¿ç¯å¢ƒ
- ä¸{{user}}çš„å†å²
- é‡è¦è®°å¿†

äººé™…å…³ç³»éƒ¨åˆ†ï¼š
- å®¶åº­ã€æœ‹å‹å…³ç³»
- å¯¹{{user}}çš„å…³ç³»å®šä½ã€ç›¸å¤„æ¨¡å¼ã€å†…å¿ƒæƒ³æ³•ã€ææƒ§ã€æœŸå¾…
- å¯¹å…¶ä»–äººçš„æ€åº¦

æ¼”ç»æŒ‡å¯¼éƒ¨åˆ†ï¼š
- è¯­è¨€æ¨¡å¼ã€åŠ¨ä½œä¹ æƒ¯
- æƒ…æ„Ÿå›è·¯ã€äº’åŠ¨å‡†åˆ™
- æ€ç»´æ–¹å¼ã€å†³æ–­æ ‡å‡†
- äººæ ¼åº•çº¿ã€å¤šé¢æ€§å±•ç°

NSFWæ¡£æ¡ˆéƒ¨åˆ†ï¼ˆå¦‚éœ€è¦ï¼‰ï¼š
- æ€§ç»éªŒã€æ€§çŸ¥è¯†ã€æ•æ„Ÿéƒ¨ä½
- æ€§æ ¼å€¾å‘ã€åå¥½ç±»å‹ã€ç¦å¿Œåº•çº¿
- ç”Ÿç†ååº”ç‰¹å¾ã€å¿ƒç†çŠ¶æ€
- ç‰¹æ®Šåå¥½ã€åˆæ¬¡ååº”é¢„æµ‹
- æ„å¤–çš„ä¸»åŠ¨æ—¶åˆ»ã€å‘å±•æ½œåŠ›

æ—¥å¸¸å¯¹è¯è¯­æ–™éƒ¨åˆ†ï¼š
- å„ç§åœºæ™¯ä¸‹çš„å¯¹è¯ç¤ºä¾‹
- æƒ…æ„Ÿè¡¨è¾¾ã€è¡Œä¸ºç»†èŠ‚
- å®Œæ•´åœºæ™¯ç¤ºä¾‹

ç‰¹åˆ«æ³¨æ„ï¼š
- åœ¨è§’è‰²å¡ä¸­ï¼Œæ‰€æœ‰æ¶‰åŠç”¨æˆ·çš„åœ°æ–¹éƒ½å¿…é¡»ä½¿ç”¨ {{user}} æ¥è¡¨ç¤º
- ä¸è¦ä½¿ç”¨"ç”¨æˆ·"ã€"ä½ "ç­‰è¯æ±‡ï¼Œç»Ÿä¸€ä½¿ç”¨ {{user}}
- ä¾‹å¦‚ï¼šå¯¹{{user}}çš„æ€åº¦ã€ä¸{{user}}çš„å…³ç³»ã€{{user}}çš„ç§°å‘¼ç­‰
- ä¸¥æ ¼ç¦æ­¢å‡ºç°æ‹¬å·å†…å¸¦è‹±æ–‡çš„æƒ…å†µï¼ˆå¦‚"é¡¾è¨€ (Gu Yan)"åº”æ”¹ä¸º"é¡¾è¨€"ï¼‰
- æ˜µç§°éƒ¨åˆ†ä¸è¦åŒ…å«è‹±æ–‡ï¼Œçº¯ä¸­æ–‡å³å¯
- èº«é«˜ç”¨æè¿°æ€§è¯­è¨€ï¼Œä¸è¦ç”¨å…·ä½“æ•°å­—
- å§“åéƒ¨åˆ†åªèƒ½å†™ä¸­æ–‡åï¼Œä¸è¦æ·»åŠ ä»»ä½•è‹±æ–‡æˆ–æ‹¬å·
- æ‰€æœ‰æ‹¬å·å†…å®¹éƒ½å¿…é¡»æ˜¯çº¯ä¸­æ–‡
- ç¦æ­¢ä½¿ç”¨Markdownæ ¼å¼ç¬¦å·ï¼ˆå¦‚#ã€*ã€**ã€-ç­‰ï¼‰ï¼Œåªä½¿ç”¨çº¯YAMLæ ¼å¼
- ä¸è¦æ·»åŠ ä»»ä½•æ³¨é‡Šç¬¦å·æˆ–ç‰¹æ®Šæ ‡è®°

è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä¸ªå®Œæ•´ã€ä¸“ä¸šã€è¯¦ç»†çš„YAMLæ ¼å¼è§’è‰²å¡ã€‚`,
          },
          {
            role: 'user',
            content: `è¯·æ ¹æ®ä»¥ä¸‹è§’è‰²æè¿°ç”Ÿæˆå®Œæ•´çš„è§’è‰²å¡ï¼š

${characterDescription.value}

è¯·æŒ‰ç…§YAMLæ ¼å¼ç”Ÿæˆä¸€ä¸ªå®Œæ•´ã€ä¸“ä¸šçš„è§’è‰²å¡ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„éƒ¨åˆ†ã€‚`,
          },
        ],
      }),
    });

    if (!response.ok) {
      throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
    }

    const data = await response.json();
    const characterCard = data.choices[0].message.content.trim();

    // è°ƒè¯•ä¿¡æ¯
    console.log('APIå“åº”æ•°æ®:', data);
    console.log('ç”Ÿæˆçš„è§’è‰²å¡é•¿åº¦:', characterCard.length);
    console.log('è§’è‰²å¡å†…å®¹é¢„è§ˆ:', characterCard.substring(0, 200) + '...');
    console.log('è§’è‰²å¡ç»“å°¾é¢„è§ˆ:', '...' + characterCard.substring(characterCard.length - 200));

    if (characterCard && characterCard.length > 0) {
      characterCardOutput.value = characterCard;
      window.toastr.success(`è§’è‰²å¡ç”Ÿæˆå®Œæˆï¼é•¿åº¦: ${characterCard.length} å­—ç¬¦`);
    } else {
      throw new Error('ç”Ÿæˆçš„å†…å®¹ä¸ºç©º');
    }
  } catch (error) {
    console.error('è§’è‰²å¡ç”Ÿæˆå¤±è´¥:', error);
    window.toastr.error(`ç”Ÿæˆå¤±è´¥: ${(error as Error).message}`);
  } finally {
    isGeneratingCharacter.value = false;
  }
};

const clearCharacterForm = () => {
  characterDescription.value = '';
  characterCardOutput.value = '';
  editInstructions.value = '';
  window.toastr.success('å†…å®¹å·²æ¸…ç©º');
};

// ç¼–è¾‘è§’è‰²å¡
const handleEditCharacterCard = async () => {
  if (!editInstructions.value.trim()) {
    window.toastr.warning('è¯·è¾“å…¥ä¿®æ”¹è¯´æ˜');
    return;
  }

  if (!characterCardOutput.value.trim()) {
    window.toastr.warning('æ²¡æœ‰å¯ä¿®æ”¹çš„è§’è‰²å¡');
    return;
  }

  try {
    isEditingCharacter.value = true;
    window.toastr.info('AIæ­£åœ¨ä¿®æ”¹è§’è‰²å¡ï¼Œè¯·ç¨å€™...');

    const response = await fetch(settings.value.api_endpoint, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${settings.value.api_key}`,
      },
      body: JSON.stringify({
        model: settings.value.model || 'gpt-3.5-turbo',
        messages: [
          {
            role: 'system',
            content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è§’è‰²å¡ä¿®æ”¹ä¸“å®¶ã€‚è¯·æ ¹æ®ç”¨æˆ·çš„ä¿®æ”¹è¦æ±‚ï¼Œå¯¹ç°æœ‰çš„è§’è‰²å¡è¿›è¡Œä¿®æ”¹ã€‚

é‡è¦ï¼šè¯·ä½¿ç”¨æ ‡å‡†çš„YAMLæ ¼å¼ï¼ŒåŒ…å«æ­£ç¡®çš„ç¼©è¿›å’Œç»“æ„ã€‚åœ¨è§’è‰²å¡ä¸­ï¼Œç”¨æˆ·ç»Ÿä¸€ç”¨ {{user}} æ¥è¡¨ç¤ºã€‚

æ ¼å¼è¦æ±‚ï¼š
- å§“åéƒ¨åˆ†åªèƒ½å†™ä¸­æ–‡åï¼Œç¦æ­¢æ·»åŠ è‹±æ–‡æˆ–æ‹¬å·ï¼ˆå¦‚"é¡¾è¨€ (Gu Yan)"åº”æ”¹ä¸º"é¡¾è¨€"ï¼‰
- æ˜µç§°éƒ¨åˆ†ä¸è¦åŒ…å«è‹±æ–‡ï¼Œçº¯ä¸­æ–‡å³å¯
- èº«é«˜ç”¨æè¿°æ€§è¯­è¨€ï¼Œä¸è¦ç”¨å…·ä½“æ•°å­—
- æ‰€æœ‰æ‹¬å·å†…å®¹éƒ½å¿…é¡»æ˜¯çº¯ä¸­æ–‡
- ç¦æ­¢ä½¿ç”¨Markdownæ ¼å¼ç¬¦å·ï¼ˆå¦‚#ã€*ã€**ã€-ç­‰ï¼‰ï¼Œåªä½¿ç”¨çº¯YAMLæ ¼å¼
- ä¸è¦æ·»åŠ ä»»ä½•æ³¨é‡Šç¬¦å·æˆ–ç‰¹æ®Šæ ‡è®°

è¯·æ ¹æ®ç”¨æˆ·çš„ä¿®æ”¹è¦æ±‚ï¼Œå¯¹ç°æœ‰è§’è‰²å¡è¿›è¡Œä¿®æ”¹ï¼Œä¿æŒåŸæœ‰çš„ç»“æ„å’Œé£æ ¼ï¼Œåªä¿®æ”¹ç”¨æˆ·æŒ‡å®šçš„éƒ¨åˆ†ã€‚`,
          },
          {
            role: 'user',
            content: `ç°æœ‰è§’è‰²å¡ï¼š
${characterCardOutput.value}

ä¿®æ”¹è¦æ±‚ï¼š
${editInstructions.value}

è¯·æ ¹æ®ä¿®æ”¹è¦æ±‚ï¼Œç”Ÿæˆä¿®æ”¹åçš„å®Œæ•´è§’è‰²å¡ã€‚`,
          },
        ],
        temperature: 0.7,
      }),
    });

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    characterCardOutput.value = data.choices[0].message.content;
    editInstructions.value = ''; // æ¸…ç©ºç¼–è¾‘è¯´æ˜
    window.toastr.success('è§’è‰²å¡ä¿®æ”¹æˆåŠŸï¼');
  } catch (error) {
    console.error('ä¿®æ”¹è§’è‰²å¡å¤±è´¥:', error);
    window.toastr.error('ä¿®æ”¹è§’è‰²å¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ç¨åé‡è¯•');
  } finally {
    isEditingCharacter.value = false;
  }
};

// é‡ç½®ç¼–è¾‘è¡¨å•
const resetEditForm = () => {
  editInstructions.value = '';
};

const copyCharacterCard = () => {
  if (!characterCardOutput.value) {
    window.toastr.warning('æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹');
    return;
  }

  console.log('å¼€å§‹å¤åˆ¶è§’è‰²å¡ï¼Œå†…å®¹é•¿åº¦:', characterCardOutput.value.length);
  console.log('è§’è‰²å¡å†…å®¹é¢„è§ˆ:', characterCardOutput.value.substring(0, 100) + '...');

  // ä½¿ç”¨ç»Ÿä¸€çš„å¤åˆ¶å‡½æ•°
  copyToClipboard(characterCardOutput.value, 'è§’è‰²å¡å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
};

</script>

<style scoped>
.tools-tab {
  height: 100%;
  overflow-y: auto;
  padding: 25px !important;
}

.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 25px !important;
  border-bottom: 1px solid #3a3a3a;
  margin-bottom: 5px;
}

.section-header h3 {
  margin: 0;
  color: #fff;
  font-size: 15px !important;
  font-weight: bold;
  display: flex;
  align-items: center;
  gap: 8px;
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

.count-badge {
  background: #4a9eff;
  color: white;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
}

.tools-list {
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin-top: 20px;
  padding: 0 20px 20px;
}

.tool-item {
  background: #2a2a2a;
  border: 1px solid #444;
  border-radius: 8px;
  padding: 15px;
  transition: all 0.3s ease;
}

.tool-item:hover {
  border-color: #4a9eff;
  background: #2d2d2d;
}

.tool-header {
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.tool-header h4 {
  margin: 0;
  color: #fff;
  font-size: 16px;
  font-weight: 600;
}

.tool-description {
  color: #ccc;
  font-size: 14px;
  line-height: 1.5;
  margin: 0;
}

.expand-icon {
  transition: transform 0.3s ease;
  color: #888;
}

.tool-content {
  margin-top: 15px;
  padding: 15px;
  background: #1e1e1e;
  border: 1px solid #333;
  border-radius: 6px;
}

.tool-content-text {
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.6;
  color: #e0e0e0;
  white-space: pre-wrap;
  word-wrap: break-word;
  user-select: text;
  cursor: text;
}

.mini-button {
  padding: 6px 12px;
  background: #2a2a2a;
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  color: #e0e0e0;
  cursor: pointer;
  font-size: 12px;
  transition: background 0.2s;
}

.mini-button:hover {
  background: #3a3a3a;
}

.mini-button.test-button:hover {
  background: #e0a800;
  border-color: #e0a800;
  color: #212529;
}

/* åå…«è‚¡å·¥å…·æ ·å¼ */
.anti-cliche-tool {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.tool-section {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.tool-section h5 {
  margin: 0;
  color: #fff;
  font-size: 14px;
  font-weight: 600;
}

.anti-cliche-textarea {
  width: 100%;
  min-height: 120px;
  padding: 12px;
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  color: #e0e0e0;
  font-size: 13px;
  line-height: 1.5;
  resize: vertical;
  font-family: inherit;
}

.anti-cliche-textarea:focus {
  outline: none;
  border-color: #4a9eff;
}

.tool-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.process-button {
  background: #4a9eff;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: background 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.process-button:hover:not(:disabled) {
  background: #5aaeff;
}

.process-button:disabled {
  background: #666;
  cursor: not-allowed;
  opacity: 0.6;
}

.clear-button {
  background: #666;
  color: white;
  border: none;
  padding: 10px 16px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 13px;
  font-weight: 600;
  transition: background 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.clear-button:hover:not(:disabled) {
  background: #777;
}

.clear-button:disabled {
  background: #444;
  cursor: not-allowed;
  opacity: 0.6;
}

.anti-cliche-output {
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  padding: 12px;
  color: #e0e0e0;
  font-size: 13px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-wrap: break-word;
  max-height: 300px;
  overflow-y: auto;
}

.output-actions {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  padding: 15px 20px;
  background: #2a2a2a;
  border-top: 1px solid #3a3a3a;
  margin: 0;
}

.copy-button {
  background: #28a745 !important;
  color: white !important;
  border: none !important;
  padding: 8px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  transition: background 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.copy-button:hover {
  background: #218838 !important;
}


.tool-instructions {
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  padding: 12px;
  color: #ccc;
  font-size: 12px;
  line-height: 1.5;
}

.tool-instructions p {
  margin: 0 0 8px 0;
}

.tool-instructions p:last-child {
  margin-bottom: 0;
}

/* è§’è‰²å¡ç”Ÿæˆå·¥å…·æ ·å¼ */
.character-template-tool {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.character-form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.form-group {
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.form-group label {
  font-weight: 500;
  color: #e0e0e0;
  font-size: 14px;
}

.character-input,
.character-select,
.character-textarea {
  padding: 8px 12px;
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  font-size: 14px;
  transition: border-color 0.2s;
  background: #2a2a2a;
  color: #e0e0e0;
}

.character-input:focus,
.character-select:focus,
.character-textarea:focus {
  outline: none;
  border-color: #4a9eff;
  box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.1);
}

.character-textarea {
  min-height: 80px;
  resize: vertical;
}

.generate-button {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 8px;
}

.generate-button:hover:not(:disabled) {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.generate-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.character-card-container {
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 8px;
  padding: 0;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.character-card-textarea {
  width: 100%;
  background: #1a1a1a;
  border: none;
  border-radius: 0;
  padding: 20px;
  max-height: 600px;
  min-height: 300px;
  overflow-y: auto;
  color: #e0e0e0;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.5;
  resize: vertical;
  scrollbar-width: thin;
  scrollbar-color: #4a9eff #2a2a2a;
  white-space: pre-wrap;
  word-wrap: break-word;
  margin: 0;
  outline: none;
}

.character-card-textarea:focus {
  outline: none;
  border: none;
}

.character-card-textarea::placeholder {
  color: #666;
  font-style: italic;
}

.character-card-textarea::-webkit-scrollbar {
  width: 8px;
}

.character-card-textarea::-webkit-scrollbar-track {
  background: #2a2a2a;
  border-radius: 4px;
}

.character-card-textarea::-webkit-scrollbar-thumb {
  background: #4a9eff;
  border-radius: 4px;
}

.character-card-textarea::-webkit-scrollbar-thumb:hover {
  background: #5ba8ff;
}

.character-card-output pre {
  margin: 0;
  padding: 0;
  background: transparent;
  border: none;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.5;
  white-space: pre-wrap;
  word-wrap: break-word;
  color: #e0e0e0;
}

.character-card-output code {
  background: transparent;
  border: none;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  line-height: 1.5;
  white-space: pre-wrap;
  word-wrap: break-word;
  color: #e0e0e0;
}

/* ç¼–è¾‘åŒºåŸŸæ ·å¼ */
.edit-section {
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 6px;
  padding: 15px;
  margin-top: 10px;
}

.edit-label {
  display: block;
  color: #e0e0e0;
  font-weight: bold;
  margin-bottom: 8px;
  font-size: 14px;
}

.edit-textarea {
  width: 100%;
  min-height: 120px;
  max-height: 200px;
  padding: 12px;
  background: #2a2a2a;
  border: 1px solid #4a4a4a;
  border-radius: 4px;
  color: #e0e0e0;
  font-size: 13px;
  line-height: 1.5;
  resize: vertical;
  font-family: inherit;
}

.edit-textarea:focus {
  outline: none;
  border-color: #4a9eff;
  box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2);
}

.edit-textarea::placeholder {
  color: #888;
}

.edit-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

.edit-button {
  background: #4a9eff !important;
  color: white !important;
  border: none !important;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: background 0.2s;
}

.edit-button:hover:not(:disabled) {
  background: #5ba8ff !important;
}

.edit-button:disabled {
  background: #666 !important;
  cursor: not-allowed;
}

.reset-button {
  background: #666 !important;
  color: white !important;
  border: none !important;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 6px;
  transition: background 0.2s;
}

.reset-button:hover {
  background: #777 !important;
}

/* ç¾åŒ–æŒ‰é’®çš„æ‚¬åœæ•ˆæœ */
.process-button:hover:not(:disabled) .shimmer-effect,
.clear-button:hover:not(:disabled) .shimmer-effect,
.generate-button:hover:not(:disabled) .shimmer-effect,
.copy-button:hover .shimmer-effect {
  left: 100%;
}

.process-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.clear-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
}

.generate-button:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.copy-button:hover {
  transform: translateY(-1px);
  box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
}


.process-button:disabled,
.clear-button:disabled,
.generate-button:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
}
</style>
